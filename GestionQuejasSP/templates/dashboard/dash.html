{% extends "base.html" %}

{% load static %}

{% block content %}

   <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Registro de Quejas</h1>
    <div class="d-flex align-items-center">
      <div class="btn-group me-2">
        <button type="button" class="btn btn-sm btn-outline-secondary">Compartir</button>
        <button type="button" class="btn btn-sm btn-outline-secondary">Exportar</button>
      </div>
      <div class="d-flex flex-grow-1">
        <form method="get" action="{% url 'dash' %}" class="d-flex flex-grow-1">
          {% csrf_token %}
          <div class="form-group mb-0 me-2">
            <label for="id_years" class="form-label">Año:</label>
            {{ form.years }}
          </div>
          <button type="submit" class="btn btn-primary">Filtrar</button>
        </form>
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="table-responsive table-responsive-xl">
      <table class="table table-striped table-sm table-bordered" id="mi-tabla">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Nombre/Apellidos</th>
      <th scope="col">Entidad Afectada</th>
      <th scope="col">Modalidad</th>
      <th scope="col">Vía</th>
      <th scope="col">Procedencia</th>
      <th scope="col">Clasificación</th>
      <th scope="col">Caso Prensa</th>
      <th scope="col">Entrega</th>
      <th scope="col">Satisfacción</th>
      <th scope="col">Conclusión</th>
      <th scope="col">Fecha de Registro</th>
      <th scope="col">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for queja in quejas %}
    <tr>
      <td>{{ queja.numero }}</td>
      <td>{{ queja.nombre_apellidos }}</td>
      <td>{{ queja.entidadAfectada }}</td>
      <td>{{ queja.modalidad }}</td>
      <td>{{ queja.via }}</td>
      <td>{{ queja.procedencia }}</td>
      <td>{{ queja.clasificacion }}</td>
      <td>{{ queja.casoPrensa }}</td>
      {% if queja.respuesta %}
      <td>{{ queja.respuesta.entrega }}</td>
      <td>{{ queja.respuesta.satisfaccion }}</td>
      <td>{{ queja.respuesta.conclusion }}</td>
      {% else %}
      <td></td>
      <td></td>
      <td></td>
      {% endif %}
      <td>{{ queja.fechaR|date:"d/m" }}</td>
      <td>
        {% if queja.numero %}
        <a href="{% url 'modificarQ_with_numero' pk=queja.pk %}" class="btn btn-primary btn-sm">Editar</a>
        <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="eliminarQuejaModal" data-id="{{ queja.pk }}">Eliminar</button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Ventana modal para confirmar la eliminación de una queja -->
<div class="modal fade" id="eliminarQuejaModal" tabindex="-1" role="dialog" aria-labelledby="eliminarQuejaModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eliminarQuejaModalLabel">Eliminar Queja</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que quieres eliminar la queja?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="eliminarQuejaBoton">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Código JavaScript para manejar la confirmación de eliminación -->
<script>
$(document).ready(function() {
  $('#eliminarQuejaModal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget); // Botón que abrió la ventana modal
    var quejaId = button.data('id'); // Extraer el ID de la queja de los datos del botón
    var modal = $(this);
    modal.find('#eliminarQuejaBoton').on('click', function() {
      var url = '/eliminarQ/' + quejaId + '/';
      $.ajax({
        url: url,
        type: 'DELETE',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}' // Agrega la etiqueta de seguridad CSRF
        },
        success: function() {
          window.location.reload();
        },
        error: function() {
          alert('Error al eliminar la queja.');
        }
      });
    });
  });
});
</script>

    </div>
  </div>
</main>

{% endblock %}